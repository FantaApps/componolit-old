#!/usr/bin/env python3

import sys
import re

from pyparsing import *

#
# Android.rb file grammar
#

comma       = Literal (',')
colon       = Literal (':')
plus        = Literal ('+')
equals      = Literal ('=')
true        = Literal ('true')
false       = Literal ('false')
name        = Word (alphanums + "_")
variable    = name

#
# Boolean literal true/false
#
boolean     = true | false

#
# String
#
string      = QuotedString ('"', escChar='\\')
stringjoin  = string + ZeroOrMore (plus + (string|variable))

#
# List of strings
#
stringlist     = Literal ("[") + Optional (delimitedList (stringjoin)) + Optional (comma) + Literal ("]")
stringlistjoin = (stringlist|variable) + ZeroOrMore (plus + (stringlist|variable))

#
# Dictionary
#
dictelem    = Forward()
dictionary  = Literal ("{") + Optional (delimitedList (dictelem)) + Optional (comma) + Literal ("}")

# Element
element   = stringjoin | stringlistjoin | boolean | dictionary | variable
dictelem << name + (colon|equals) + element

block       = name + element
assignment  = name + Literal ("=") + element
extension   = name + Literal ("+=") + element

soong       = ZeroOrMore (block | assignment | extension) + StringEnd()

# C and C++ style comments
soong.ignore (cppStyleComment | cStyleComment)

good = 0
fail = 0

# parse input file
for arg in sys.argv[1:]:
    try:
        soong.parseFile (arg)
        good += 1
    except ParseException as e:
        print ("Parse error in %s: %s" % (arg, str(e)))
        fail += 1

print ("good: %d, fail: %d (%2.1f)" % (good, fail, 100 * fail / (good + fail)))
